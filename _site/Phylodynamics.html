<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hayley Cassidy">
<meta name="dcterms.date" content="2025-12-04">

<title>Generating Phylodynamic Trees â€“ Metagenomics Nanopore Workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Generating_Phylogenetic_Trees.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f3c7dabe75a0c4d0cadd41566b53a9a4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles_logo.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Preparation_and_Reference_Collection.html">Phylodynamics</a></li><li class="breadcrumb-item"><a href="./Phylodynamics.html">Generating Phylodynamic Trees</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nanopore Metagenomics analysis manual</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Quality_Control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quality Control</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Removing_host_reads.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Removing Host Reads</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Classification</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Taxonomic_Classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Taxonomic Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Metagenomics_Automation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metagenomics Automation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Assembly</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Assembly.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assembly Automation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Consensus Generation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generating_Consensus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generating a Consensus Sequence</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Consensus_Visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Consensus Visualization</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Phylodynamics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Preparation_and_Reference_Collection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preparation and Reference Collection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Generating_Phylogenetic_Trees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generating Phylogenetic Trees</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Phylodynamics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Generating Phylodynamic Trees</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#nextstrain---pre-set-automated-pipeline" id="toc-nextstrain---pre-set-automated-pipeline" class="nav-link active" data-scroll-target="#nextstrain---pre-set-automated-pipeline"><span class="header-section-number">1</span> Nextstrain - pre-set automated pipeline</a>
  <ul class="collapse">
  <li><a href="#download-the-references" id="toc-download-the-references" class="nav-link" data-scroll-target="#download-the-references"><span class="header-section-number">1.1</span> Download the references</a></li>
  </ul></li>
  <li><a href="#ingest-pipeline" id="toc-ingest-pipeline" class="nav-link" data-scroll-target="#ingest-pipeline"><span class="header-section-number">2</span> Ingest pipeline</a>
  <ul class="collapse">
  <li><a href="#now-its-time-to-add-your-sequences-and-metadata" id="toc-now-its-time-to-add-your-sequences-and-metadata" class="nav-link" data-scroll-target="#now-its-time-to-add-your-sequences-and-metadata"><span class="header-section-number">2.1</span> Now its time to add your sequences and metadata</a></li>
  <li><a href="#manually-add-your-updated-files-for-the-next-script" id="toc-manually-add-your-updated-files-for-the-next-script" class="nav-link" data-scroll-target="#manually-add-your-updated-files-for-the-next-script"><span class="header-section-number">2.2</span> Manually add your updated files for the next script</a></li>
  <li><a href="#phylogenetic-pipeline" id="toc-phylogenetic-pipeline" class="nav-link" data-scroll-target="#phylogenetic-pipeline"><span class="header-section-number">2.3</span> Phylogenetic pipeline</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="header-section-number">2.4</span> Visualization</a></li>
  </ul></li>
  <li><a href="#nextstrain---creating-your-own-pipeline" id="toc-nextstrain---creating-your-own-pipeline" class="nav-link" data-scroll-target="#nextstrain---creating-your-own-pipeline"><span class="header-section-number">3</span> Nextstrain - creating your own pipeline</a>
  <ul class="collapse">
  <li><a href="#make-sure-you-are-in-the-right-path" id="toc-make-sure-you-are-in-the-right-path" class="nav-link" data-scroll-target="#make-sure-you-are-in-the-right-path"><span class="header-section-number">3.1</span> Make sure you are in the right path</a></li>
  <li><a href="#indexing" id="toc-indexing" class="nav-link" data-scroll-target="#indexing"><span class="header-section-number">3.2</span> Indexing</a></li>
  <li><a href="#aligning" id="toc-aligning" class="nav-link" data-scroll-target="#aligning"><span class="header-section-number">3.3</span> Aligning</a></li>
  <li><a href="#generating-a-raw-tree" id="toc-generating-a-raw-tree" class="nav-link" data-scroll-target="#generating-a-raw-tree"><span class="header-section-number">3.4</span> Generating a raw tree</a></li>
  <li><a href="#refining-the-tree" id="toc-refining-the-tree" class="nav-link" data-scroll-target="#refining-the-tree"><span class="header-section-number">3.5</span> Refining the tree</a></li>
  <li><a href="#adding-traits" id="toc-adding-traits" class="nav-link" data-scroll-target="#adding-traits"><span class="header-section-number">3.6</span> Adding traits</a></li>
  <li><a href="#adding-mutation-data" id="toc-adding-mutation-data" class="nav-link" data-scroll-target="#adding-mutation-data"><span class="header-section-number">3.7</span> Adding mutation data</a></li>
  <li><a href="#adding-protein-data" id="toc-adding-protein-data" class="nav-link" data-scroll-target="#adding-protein-data"><span class="header-section-number">3.8</span> Adding protein data</a></li>
  <li><a href="#exporting" id="toc-exporting" class="nav-link" data-scroll-target="#exporting"><span class="header-section-number">3.9</span> Exporting</a></li>
  <li><a href="#visulization" id="toc-visulization" class="nav-link" data-scroll-target="#visulization"><span class="header-section-number">3.10</span> Visulization</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Preparation_and_Reference_Collection.html">Phylodynamics</a></li><li class="breadcrumb-item"><a href="./Phylodynamics.html">Generating Phylodynamic Trees</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Generating Phylodynamic Trees</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hayley Cassidy </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 4, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>While phylogenetic and phylodynamic trees both depict evolutionary relationships, phylodynamic trees incorporate temporal information and epidemiological models to understand how evolutionary patterns arise in the context of time and population dynamics, often using time-scaled trees.</p>
<p>We can apply the <a href="https://docs.nextstrain.org/projects/augur/en/stable/">augur</a> pipeline on <a href="https://docs.nextstrain.org/en/latest/index.html">Nextstrain</a> to generate these timetrees. Augur is composed of a series of modules and different workflows which use different parts of the pipeline. A selection of the different input and output files are illustrated below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="augur.jpg" class="img-fluid figure-img"></p>
<figcaption>Augur workflow</figcaption>
</figure>
</div>
<p>Nextstrain maintains analyses of several selected <a href="https://nextstrain.org/pathogens#list">pathogens</a>, such as SARS-CoV-2 and influenza to show pathogen evolution and epidemic spread. Nextstrain continually update sequencing data for selected pathogens as new data is made publicly available. Automated pipelines are available for the following viral targets:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Nextstrain_pathogens.jpg" class="img-fluid figure-img"></p>
<figcaption>Viral targets with automated pipelines</figcaption>
</figure>
</div>
<section id="nextstrain---pre-set-automated-pipeline" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="nextstrain---pre-set-automated-pipeline"><span class="header-section-number">1</span> Nextstrain - pre-set automated pipeline</h2>
<p>Please follow the steps for running an automated pipeline for the above pre-set targets on Nextstrain <a href="https://docs.nextstrain.org/en/latest/install.html">here</a>.</p>
<p><strong style="color:darkblue">For the purpose of this guide, we will now follow an example automated workflow for mpox</strong></p>
<p>It would be a good idea to have all our Nextstrain builds in the same folder. Please create one now if you have not already done so.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> Nextstrain_builds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You also need to be in the right environment:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> deactivate nanopore_diagnostics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate nextstrain2025</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="download-the-references" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="download-the-references"><span class="header-section-number">1.1</span> Download the references</h3>
<p>You first need to go to the Nextstrain github page for your virus of interest. We will use <a href="https://github.com/nextstrain/mpox/tree/master?tab=readme-ov-file">mpox</a>as an example.</p>
<p><img src="github.jpg" class="img-fluid" alt="Example"> Click <strong>Code</strong> and then <strong>Download ZIP</strong>. This zip contains all your scripts you need for the pipeline.</p>
<p>Now extract and save your zipped file (in this case <strong>mpox-master</strong>) in our newly created folder <strong>Nextstrain_builds</strong>.</p>
<p>You now need to download all the curated reference sequences (these sequences are continually updated as new sequences become available). As the scripts contained in <strong>mpox-master</strong> assume you are within the ingest directory, please copy the following command:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now you can â€œfetchâ€ all the curated reference sequences:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextstrain</span> build . data/ncbi.ndjson</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="ingest-pipeline" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="ingest-pipeline"><span class="header-section-number">2</span> Ingest pipeline</h2>
<p>Next you will run the â€œingestâ€ pipeline. The ingest pipeline in Nextstrain takes raw sequence data (e.g., from NCBI) and filters, standardizes and outputs cleaned fasta and metadata files named â€œsequences.fastaâ€ and â€œmetadata.tsvâ€. These are your input files for the next pipeline.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextstrain</span> build .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Check these two files have been created.</p>
</div>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="now-its-time-to-add-your-sequences-and-metadata" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="now-its-time-to-add-your-sequences-and-metadata"><span class="header-section-number">2.1</span> Now its time to add your sequences and metadata</h3>
<ol type="i">
<li><p>First add your individual <strong>fasta</strong> sequence(s) of interest to the â€œ/mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/â€ folder. The sequence name and file name should match. To check the sequence name, open with bioedit, Aliview or notepad.</p></li>
<li><p>You next need to combine your downloaded reference fasta (named <strong>sequences.fasta</strong>) with your sequence(s) of interest (in this case we will use <strong>sample.fasta</strong>)</p></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro000-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> Sample.fasta <span class="op">&gt;&gt;</span> sequences.fasta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember <strong>cat</strong> just means concatenate.</p>
</div>
</div>
<ol start="3" type="i">
<li>You also need to combine your downloaded reference metadata (<strong>metadata.tsv</strong>) with the metadata of your virus of interest</li>
</ol>
<p>The following image offers an example of the metadata layout. In the columns highlighted, please provide data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="excel_for_nextstrain_pre_set.png" class="img-fluid figure-img"></p>
<figcaption>Example files</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to delete the pre-existing data in row two of the excel file (this is just an example) and replace with your own metadata!</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The â€œstrainâ€ name should match the fasta file (e.g sample number). If the accession number is unknown, just use the same name as the â€œstrainâ€. If the â€œdate_releasedâ€ and â€œdate_updatedâ€ are unknown, just use the sampling date and then the date of this analysis. For fields such as clade, coverage and nonACGTN, please upload the sequences onto <a href="https://clades.nextstrain.org/">Nextclade</a>. Just drag and drop the consensus sequences and select the right reference database (in this case mpox).</p>
</div>
</div>
<p>Save the excel sheet as â€œnew_metadata.txtâ€ (tab-delimited) in the â€œ/mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/â€ folder then change the file extension to <strong>tsv</strong>.</p>
<p>Now run the following command to combine the metadata files:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-n</span> +2 new_metadata.tsv <span class="op">&gt;&gt;</span> metadata.tsv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tail -n +2</strong> â€“ skips the first line (header) of the new file.</p>
<p>Below you can see an example of the files:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="path_files_ingest.jpg" class="img-fluid figure-img"></p>
<figcaption>Example files</figcaption>
</figure>
</div>
</section>
<section id="manually-add-your-updated-files-for-the-next-script" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="manually-add-your-updated-files-for-the-next-script"><span class="header-section-number">2.2</span> Manually add your updated files for the next script</h3>
<p>Next you need to copy your updated files (sequence.fasta and metadata.tsv) into another folder (<strong>phylogenetic</strong>) for the next script:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/sequences.fasta /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/phylogenetic/data/</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/ingest/results/metadata.tsv /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/phylogenetic/data/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="phylogenetic-pipeline" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="phylogenetic-pipeline"><span class="header-section-number">2.3</span> Phylogenetic pipeline</h3>
<p>Once you have coped over the files, make sure you are in the right folder:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Nextstrain_builds/mpox-master/phylogenetic/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now just run the following command. The phylogenetic pipeline uses the cleaned fasta and metadata from ingest, aligns sequences, builds and refines a phylogenetic tree, annotates it with traits or mutations, and outputs an Auspice JSON ready for interactive visualization.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextstrain</span> build .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Just let the script run.</p>
</section>
<section id="visualization" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="visualization"><span class="header-section-number">2.4</span> Visualization</h3>
<p>Once the script has finished, please run the following command. This will open your phylodynamic tree on a web browser for visualization.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nextstrain</span> view .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Use the filter to find your sequences (zoom into the tree by clicking branches). Play around with the different metadata fields (e.g.&nbsp;country, genotype etc.), tree layouts and branch lengths (time and divergence).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mpox_auto_tree.jpg" class="img-fluid figure-img"></p>
<figcaption>Mpox example</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to update all paths for each target or sequence of interest!</p>
</div>
</div>
</section>
</section>
<section id="nextstrain---creating-your-own-pipeline" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="nextstrain---creating-your-own-pipeline"><span class="header-section-number">3</span> Nextstrain - creating your own pipeline</h2>
<p>If your selected target is not available, donâ€™t worry! It will take a little bit more effort, but we can make our own pipeline. For more information click <a href="https://docs.nextstrain.org/en/latest/tutorials/creating-a-phylogenetic-workflow.html#run-a-nextstrain-build">here</a></p>
<p>There are quite a few commands in the pipeline so lets break it up!</p>
<p><strong>For the purpose of this guide, we will again use rhinovirus A as a study virus.</strong></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure you have read through and completed any tasks in the <strong>Preparation and Reference collection</strong> chapter!</p>
</div>
</div>
<p>You first need to be in the right environment</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate nextstrain2025</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>While a Snakemake workflow could be created, the parameters often vary between pathogens. For now, this step is performed ad hoc (<strong>and within your sample folder of interest</strong>).</p>
<p>We will now add an additional folder for Nextstrain within your barcode of interest.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Viro_Run_0001/barcode01/</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> Nextstrain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>All your input files should be in this folder. If you have also created a phylogenetic tree in the previous chapter, your input sequences and metadata file will be in the folder â€œTreeâ€. You need to move them into the new â€œNextstrainâ€ folder!</p>
</div>
</div>
<section id="make-sure-you-are-in-the-right-path" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="make-sure-you-are-in-the-right-path"><span class="header-section-number">3.1</span> Make sure you are in the right path</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /mnt/viro0002-data/sequencedata/processed/Diagnostics_metagenomics/Viro_Run_0001/barcode01/Nextstrain/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="indexing" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="indexing"><span class="header-section-number">3.2</span> Indexing</h3>
<p>This step prepares your input sequences by indexing them, making it easier and faster for downstream tools to look up and access specific entries efficiently.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> index <span class="at">--sequences</span> RVA_sequences.fasta â€“output index.tsv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“sequences RVA_sequences.fasta</strong> â€“ Input FASTA file containing RVA sequences.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output index.tsv</strong> â€“ Generates an indexed TSV file of the sequences for downstream reference.</p>
</section>
<section id="aligning" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="aligning"><span class="header-section-number">3.3</span> Aligning</h3>
<p>Aligns all your sequences to a common reference frame so that theyâ€™re directly comparable, base by base. This is necessary for identifying mutations and building a phylogenetic tree.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> align <span class="at">--sequences</span> RVA_sequences.fasta <span class="at">--output</span> sequences_aligned.fasta <span class="at">--fill-gaps</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“sequences RVA_sequences.fasta</strong> â€“ Input unaligned nucleotide sequences.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output sequences_aligned.fasta</strong> â€“ Output aligned sequences in FASTA format.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“fill-gaps</strong> â€“ Fills internal alignment gaps with reference characters for consistency.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Always check the alignment file (using bioedit or aliview). You may need to remove reference sequences which are problematic. Remember to <strong>also</strong> remove or update these references in the metadata.tsv file and re-run the alignment.</p>
</div>
</div>
</section>
<section id="generating-a-raw-tree" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="generating-a-raw-tree"><span class="header-section-number">3.4</span> Generating a raw tree</h3>
<p>Constructs a basic phylogenetic tree from the aligned sequences using a selected algorithm (e.g., IQ-TREE). This tree shows the relationships between sequences based on their similarity.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> tree <span class="at">--alignment</span> sequences_aligned.fasta <span class="at">--output</span> tree_raw.nwk <span class="at">--substitution-model</span> GTR+G <span class="at">--method</span> iqtree <span class="at">--nthreads</span> 16</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“alignment sequences_aligned.fasta</strong> â€“ Input aligned FASTA file.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output tree_raw.nwk</strong> â€“ Outputs a raw tree in Newick format.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“substitution-model GTR+G</strong> â€“ Sets the substitution model to General Time Reversible with Gamma-distributed rate variation.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“method iqtree</strong> â€“ Uses IQ-TREE as the inference engine.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“nthreads 16</strong> â€“ Allocates 16 CPU threads.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The substitution-model may need to be updated depending on the test or target. GTR+G is a typical model used.</p>
</div>
</div>
</section>
<section id="refining-the-tree" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="refining-the-tree"><span class="header-section-number">3.5</span> Refining the tree</h3>
<p>This is one of the most important steps. It improves the initial tree by:</p>
<p>-Calibrating it against sample collection dates to build a time-scaled phylogeny.</p>
<p>-Correcting uncertain or poor-quality branches.</p>
<p>-Estimating how the sequences evolved over time.</p>
<p>-Incorporating metadata to enrich tree interpretation</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> refine <span class="at">--tree</span> tree_raw.nwk k <span class="at">--alignment</span> sequences_aligned.fasta <span class="at">--metadata</span> meta_data.tsv <span class="at">--output-tree</span> tree.nwk <span class="at">--output-node-data</span> branch_lengths.json <span class="at">--timetree</span> <span class="at">--coalescent</span> skyline <span class="at">--covariance</span> <span class="at">--precision</span> 3 <span class="at">--date-confidence</span> <span class="at">--date-inference</span> marginal <span class="at">--branch-length-inference</span> auto <span class="at">--clock-filter-iqd</span> 0 <span class="at">--divergence-unit</span> mutations-per-site <span class="at">--stochastic-resolve</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tree tree_raw.nwk</strong> â€“ Input raw tree.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“alignment sequences_aligned.fasta</strong> â€“ Same alignment used in tree generation.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“metadata meta_data.tsv</strong> â€“ Sample metadata file with collection dates, genotypes, etc.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output-tree tree.nwk</strong> â€“ Refined tree output.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output-node-data branch_lengths.json</strong> â€“ Stores branch length data for visualization.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“timetree</strong> â€“ Converts the tree into a time-resolved tree using sample dates.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“coalescent skyline</strong> â€“ Uses a skyline coalescent model for demographic inference.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“covariance</strong> â€“ Enables covariance-aware date inference.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“branch-length-inference auto</strong> â€“ Lets Augur choose best branch length method.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“clock-filter-iqd 0</strong> â€“ Filters outlier sequences by interquartile deviation (set to 0 to disable).</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“divergence-unit mutations-per-site</strong> â€“ Units used for tree scale.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“stochastic-resolve</strong> â€“ Randomly resolves polytomies for better visualization.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Depending on the target or test, you may need to update these parameters.</p>
</div>
</div>
<section id="additional-help-with-selecting-parameters-for-the-refine-step" class="level4" data-number="3.5.1">
<h4 data-number="3.5.1" class="anchored" data-anchor-id="additional-help-with-selecting-parameters-for-the-refine-step"><span class="header-section-number">3.5.1</span> Additional help with selecting parameters for the â€œrefineâ€ step:</h4>
<p>ğŸ”¹ <strong style="color:darkblue">â€“coalescent</strong> â€“ This models how the tree should behave in time:</p>
<p>skyline: assumes population size changes over time (flexible, good for outbreaks).</p>
<p>constant: assumes a constant population size over time.</p>
<p>Use skyline if you expect varying infection rates or changing sampling over time.</p>
<p>&nbsp;</p>
<p>ğŸ”¹ <strong style="color:darkblue">â€“branch-length-inference</strong> â€“ Controls how the branch lengths (evolutionary distances) are interpreted:</p>
<p>auto: lets Augur decide the best method.</p>
<p>joint: all branch lengths are estimated together for best overall fit.</p>
<p>marginal: branch lengths are optimized one node at a time (faster, less precise).</p>
<p>Stick with auto unless youâ€™re troubleshooting.</p>
<p>&nbsp;</p>
<p>ğŸ”¹ <strong style="color:darkblue">â€“clock-filter-iqd</strong> â€“ This removes outlier sequences that donâ€™t fit the molecular clock:</p>
<p>Value of 0 disables it. Use 0 when you see strange branching or inconsistent sample dates.</p>
<p>Typical values: 2 or 4 to exclude sequences with timing or mutation issues.</p>
<p>&nbsp;</p>
<p>ğŸ”¹ <strong style="color:darkblue">â€“precision</strong> â€“ Controls numeric rounding (e.g., for branch lengths, mutation counts):</p>
<p>3 is standard (0.001 resolution).</p>
<p>You can increase to 5 for greater detail, or lower for simplicity.</p>
<p>&nbsp;</p>
</section>
</section>
<section id="adding-traits" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="adding-traits"><span class="header-section-number">3.6</span> Adding traits</h3>
<p>Maps sample metadata (like genotype or country) onto the tree to track how traits evolve or spread over time and geography. Useful for epidemiological insights.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> traits <span class="at">--tree</span> tree.nwk <span class="at">--metadata</span> meta_data.tsv <span class="at">--columns</span> genotype country <span class="at">--output-node-data</span> traits.json â€“confidence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tree tree.nwk</strong> â€“ Input refined tree.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“metadata meta_data.tsv</strong> â€“ Metadata with traits (like genotype or country).</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“columns genotype country</strong> â€“ Traits to be inferred and displayed.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output-node-data traits.json</strong> â€“ Outputs node trait information.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“confidence</strong> â€“ Adds confidence estimates for trait assignment.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Traits are extracted from the metadata.tsv file. In this example, the traits used are genotype and country, which must exist as columns in your metadata file. Be sure to update the command to match the columns available in your own metadata.tsv.</p>
</div>
</div>
</section>
<section id="adding-mutation-data" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="adding-mutation-data"><span class="header-section-number">3.7</span> Adding mutation data</h3>
<p>Infers what the ancestral sequences probably looked like at each node of the tree and what mutations occurred along each branch (at the nucleotide level).</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> ancestral <span class="at">--tree</span> tree.nwk <span class="at">--alignment</span> sequences_aligned.fasta <span class="at">--output-node-data</span> nt_muts.json <span class="at">--inference</span> joint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tree tree.nwk</strong> â€“ Refined tree input.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“alignment sequences_aligned.fasta</strong> â€“ Aligned sequences.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output-node-data nt_muts.json</strong> â€“ Outputs inferred nucleotide mutations.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“inference joint</strong> â€“ Uses joint inference (best for overall consistency).</p>
</section>
<section id="adding-protein-data" class="level3" data-number="3.8">
<h3 data-number="3.8" class="anchored" data-anchor-id="adding-protein-data"><span class="header-section-number">3.8</span> Adding protein data</h3>
<p>Converts inferred nucleotide mutations into amino acid changes (protein mutations), which are often more biologically meaningful.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> translate <span class="at">--tree</span> tree.nwk <span class="at">--ancestral-sequences</span> nt_muts.json <span class="at">--reference-sequence</span> FJ445111.gb <span class="at">--output-node-data</span> aa_muts.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tree tree.nwk</strong> â€“ Phylogenetic tree.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“ancestral-sequences nt_muts.json</strong> â€“ File with nucleotide mutations.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“reference-sequence FJ445111.gb</strong> â€“ GenBank reference for translation. In our case, FJ445111.gb is for RVA. Remember to update!</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output-node-data aa_muts.json</strong> â€“ Outputs amino acid mutations.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to update the reference gb sequence. This is typically a root or prototype strainâ€”such as the Fermon strain for EV-D68 or the Wuhan reference strain for SARS-CoV-2. If unsure, use an official curated reference from RefSeq. Place the gb sequence in the same folder before running the command.</p>
</div>
</div>
</section>
<section id="exporting" class="level3" data-number="3.9">
<h3 data-number="3.9" class="anchored" data-anchor-id="exporting"><span class="header-section-number">3.9</span> Exporting</h3>
<p>Packages all tree, metadata, mutation and trait data into a .json file that can be visualized using Auspice, the interactive Nextstrain viewer</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">augur</span> export v2 <span class="at">--tree</span> tree.nwk <span class="at">--metadata</span> meta_data.tsv <span class="at">--node-data</span> branch_lengths.json traits.json nt_muts.json aa_muts.json <span class="at">--output</span> final_output.json <span class="at">--color-by-metadata</span> genotype country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ğŸ”¹<strong style="color:darkblue">â€“tree tree.nwk</strong> â€“ Tree file for final visualization.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“metadata meta_data.tsv</strong> â€“ Sample metadata.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“node-data â€¦</strong> â€“ Adds all prior data files (traits, mutations and branch lengths).</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“output final_output.json</strong> â€“ Combined JSON for Auspice visualization.</p>
<p>ğŸ”¹<strong style="color:darkblue">â€“color-by-metadata genotype country</strong> â€“ Defines traits for coloring in the final tree.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>â€“color-by-metadata parameter must match your metadata.tsv file. The example includes â€œgenotypeâ€ and â€œcountryâ€. These must be columns present in your metadata.tsv file.</p>
</div>
</div>
</section>
<section id="visulization" class="level3" data-number="3.10">
<h3 data-number="3.10" class="anchored" data-anchor-id="visulization"><span class="header-section-number">3.10</span> Visulization</h3>
<p>Follow this <a href="https://auspice.us/">link</a> to open auspice. Auspice allows an interactive exploration of phylogenomic datasets by simply dragging &amp; dropping.</p>
<p>Drag and drop the <strong>final_output.json</strong> file onto the webpage. This file contains all your sequencing and metadata.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tree_augur.jpg" class="img-fluid figure-img"></p>
<figcaption>Example Nextstrain tree</figcaption>
</figure>
</div>
<p>Use the filter to find your sequences (zoom into the tree by clicking branches). Play around with the different metadata fields (e.g.&nbsp;country, genotype etc.), tree layouts and branch lengths (time and divergence).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If the tree doesnâ€™t appear accurate, you may need to spend more time adjusting the reference sequences or fine-tuning the parameters.</p>
</div>
</div>
<p>If you scroll to the end of aupice, you will also see the nucleotide diversity per site.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mutations.jpg" class="img-fluid figure-img"></p>
<figcaption>Example</figcaption>
</figure>
</div>
<p><strong style="color:darkblue">You now have your phylodynamic tree!</strong></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Generating_Phylogenetic_Trees.html" class="pagination-link" aria-label="Generating Phylogenetic Trees">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Generating Phylogenetic Trees</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>